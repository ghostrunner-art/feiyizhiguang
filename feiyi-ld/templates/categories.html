{% extends "base.html" %}

{% block title %}非遗分类 - 中华非物质文化遗产{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        text-align: center;
        margin-bottom: 50px;
        padding: 60px 0;
        background: linear-gradient(135deg, #2c1810 0%, #4a2c1a 50%, #2c1810 100%);
        color: #f5f1e8;
        position: relative;
        overflow: hidden;
    }
    
    .page-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="traditional" width="100" height="100" patternUnits="userSpaceOnUse"><path d="M20,20 Q30,10 40,20 Q50,30 60,20 Q70,10 80,20" stroke="%23f5f1e8" stroke-width="0.5" fill="none" opacity="0.1"/><path d="M20,80 Q30,70 40,80 Q50,90 60,80 Q70,70 80,80" stroke="%23f5f1e8" stroke-width="0.5" fill="none" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23traditional)"/></svg>');
        pointer-events: none;
    }
    
    .page-title {
        font-size: 3rem;
        font-weight: 300;
        color: #f5f1e8;
        margin-bottom: 15px;
        position: relative;
        display: inline-block;
        letter-spacing: 0.2em;
        font-family: 'STKaiti', 'KaiTi', serif;
        z-index: 1;
    }
    
    .page-title::after {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 100px;
        height: 3px;
        background: #d4af37;
    }
    
    .page-subtitle {
        font-size: 1.2rem;
        color: rgba(245, 241, 232, 0.8);
        max-width: 600px;
        margin: 0 auto;
        line-height: 1.6;
        position: relative;
        z-index: 1;
    }
    
    .categories-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 30px;
        margin: 40px 0;
    }
    
    .category-card {
        background: #f8f6f0;
        border-radius: 0;
        padding: 40px 30px;
        text-align: center;
        box-shadow: 0 8px 25px rgba(44, 24, 16, 0.1);
        transition: all 0.3s ease;
        border: 2px solid transparent;
        position: relative;
        overflow: hidden;
        cursor: pointer;
        border-top: 4px solid #d4af37;
    }
    
    .category-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.1), transparent);
        transition: left 0.5s ease;
    }
    
    .category-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 35px rgba(44, 24, 16, 0.15);
        border-color: #d4af37;
    }
    
    .category-card:hover::before {
        left: 100%;
    }
    
    .category-icon {
        font-size: 3rem;
        margin-bottom: 25px;
        display: block;
        transition: transform 0.3s ease;
        color: #d4af37;
        font-family: 'STKaiti', 'KaiTi', serif;
        font-weight: bold;
        width: 80px;
        height: 80px;
        line-height: 80px;
        border: 3px solid #d4af37;
        border-radius: 50%;
        margin: 0 auto 25px;
        background: white;
        position: relative;
        z-index: 1;
    }
    
    .category-card:hover .category-icon {
        transform: scale(1.05);
        background: #d4af37;
        color: white;
    }
    
    .category-title {
        font-size: 1.8rem;
        font-weight: 500;
        margin-bottom: 20px;
        color: #2c1810;
        transition: color 0.3s ease;
        letter-spacing: 0.05em;
    }
    
    .category-card:hover .category-title {
        color: #d4af37;
    }
    
    .category-description {
        color: #666;
        line-height: 1.6;
        margin-bottom: 25px;
        font-size: 1rem;
    }
    
    .category-stats {
        display: flex;
        justify-content: space-around;
        margin: 25px 0;
        padding: 20px 0;
        border-top: 1px solid #d4af37;
        border-bottom: 1px solid #d4af37;
        background: rgba(212, 175, 55, 0.05);
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-number {
        font-size: 1.5rem;
        font-weight: 600;
        color: #d4af37;
        display: block;
        font-family: 'STKaiti', 'KaiTi', serif;
    }
    
    .stat-label {
        font-size: 0.9rem;
        color: #666;
        margin-top: 5px;
    }
    
    .category-link {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        color: #d4af37;
        text-decoration: none;
        font-weight: 500;
        font-size: 1.1rem;
        transition: all 0.3s ease;
        padding: 12px 25px;
        border: 2px solid #d4af37;
        border-radius: 0;
        background: transparent;
        letter-spacing: 0.05em;
    }
    
    .category-link:hover {
        background: #d4af37;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4);
    }
    
    .search-section {
        background: #f8f6f0;
        padding: 30px;
        border-radius: 0;
        box-shadow: 0 8px 25px rgba(44, 24, 16, 0.1);
        margin-bottom: 40px;
        text-align: center;
        border-top: 4px solid #d4af37;
    }
    
    .search-title {
        font-size: 1.5rem;
        font-weight: 500;
        color: #2c1810;
        margin-bottom: 20px;
        letter-spacing: 0.05em;
    }
    
    .search-form {
        display: flex;
        max-width: 500px;
        margin: 0 auto;
        gap: 15px;
    }
    
    .search-input {
        flex: 1;
        padding: 15px 20px;
        border: 2px solid #d4af37;
        border-radius: 0;
        font-size: 1rem;
        transition: border-color 0.3s ease;
        background: white;
    }
    
    .search-input:focus {
        outline: none;
        border-color: #2c1810;
        box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
    }
    
    .search-button {
        padding: 15px 30px;
        background: #d4af37;
        color: #2c1810;
        border: 2px solid #d4af37;
        border-radius: 0;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        letter-spacing: 0.05em;
    }
    
    .search-button:hover {
        background: transparent;
        color: #d4af37;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4);
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid #f8f6f0;
        border-top: 4px solid #d4af37;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
        .page-title {
            font-size: 2.5rem;
        }
        
        .categories-container {
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        .category-card {
            padding: 30px 20px;
        }
        
        .search-form {
            flex-direction: column;
        }
        
        .search-input, .search-button {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">非遗十大分类</h1>
    <p class="page-subtitle">深入了解中华非物质文化遗产的丰富内涵，探索传统文化的无穷魅力</p>
</div>

<div class="search-section">
    <h2 class="search-title">搜索非遗项目</h2>
    <form class="search-form" onsubmit="searchItems(event)">
        <input type="text" class="search-input" id="searchInput" placeholder="输入关键词搜索非遗项目...">
        <button type="submit" class="search-button">搜索</button>
    </form>
</div>

<div class="categories-container">
    {% for category in categories %}
    <div class="category-card" onclick="location.href='/category/{{ category.id }}'">
        <div class="category-icon">
            {% if category.id == 1 %}文
            {% elif category.id == 2 %}乐
            {% elif category.id == 3 %}舞
            {% elif category.id == 4 %}戏
            {% elif category.id == 5 %}曲
            {% elif category.id == 6 %}武
            {% elif category.id == 7 %}艺
            {% elif category.id == 8 %}工
            {% elif category.id == 9 %}医
            {% else %}俗
            {% endif %}
        </div>
        <h3 class="category-title">{{ category.name }}</h3>
        <p class="category-description">{{ category.description }}</p>
        
        <div class="category-stats">
            <div class="stat-item">
                <span class="stat-number" id="count-{{ category.id }}">-</span>
                <div class="stat-label">项目数量</div>
            </div>
            <div class="stat-item">
                <span class="stat-number">{{ category.id * 3 + 2 }}</span>
                <div class="stat-label">传承人</div>
            </div>
        </div>
        
        <a href="/category/{{ category.id }}" class="category-link" onclick="event.stopPropagation()">
            探索更多 →
        </a>
    </div>
    {% endfor %}
</div>

<div id="searchResults" style="display: none;">
    <h2 class="section-title">搜索结果</h2>
    <div id="searchContent"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 页面加载时获取各分类的项目数量
    document.addEventListener('DOMContentLoaded', function() {
        loadCategoryStats();
        addScrollAnimation();
    });
    
    function loadCategoryStats() {
        {% for category in categories %}
        fetch(`/api/items?category_id={{ category.id }}&per_page=1`)
            .then(response => response.json())
            .then(data => {
                const countElement = document.getElementById('count-{{ category.id }}');
                if (countElement) {
                    countElement.textContent = data.total || 0;
                }
            })
            .catch(error => {
                console.error('Error loading stats for category {{ category.id }}:', error);
                const countElement = document.getElementById('count-{{ category.id }}');
                if (countElement) {
                    countElement.textContent = '0';
                }
            });
        {% endfor %}
    }
    
    function searchItems(event) {
        event.preventDefault();
        const keyword = document.getElementById('searchInput').value.trim();
        
        if (!keyword) {
            alert('请输入搜索关键词');
            return;
        }
        
        const searchResults = document.getElementById('searchResults');
        const searchContent = document.getElementById('searchContent');
        
        // 显示加载状态
        searchContent.innerHTML = `
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>正在搜索...</p>
            </div>
        `;
        searchResults.style.display = 'block';
        
        // 滚动到搜索结果
        searchResults.scrollIntoView({ behavior: 'smooth' });
        
        fetch(`/api/search?keyword=${encodeURIComponent(keyword)}`)
            .then(response => response.json())
            .then(data => {
                displaySearchResults(data);
            })
            .catch(error => {
                console.error('Search error:', error);
                searchContent.innerHTML = `
                    <div class="error-message">
                        搜索出现错误，请稍后重试。
                    </div>
                `;
            });
    }
    
    function displaySearchResults(data) {
        const searchContent = document.getElementById('searchContent');
        
        if (data.items.length === 0 && data.knowledge.length === 0) {
            searchContent.innerHTML = `
                <div class="card" style="text-align: center; padding: 40px;">
                    <h3>未找到相关结果</h3>
                    <p>请尝试其他关键词或浏览分类页面</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        
        if (data.items.length > 0) {
            html += '<h3 style="margin: 30px 0 20px 0; color: #2c3e50;">相关项目</h3>';
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">';
            
            data.items.forEach(item => {
                html += `
                    <div class="card" style="cursor: pointer;" onclick="location.href='/item/${item.id}'">
                        <h4 style="color: #d4af37; margin-bottom: 10px;">${item.name}</h4>
                        <p style="color: #666; margin-bottom: 15px;">${item.description}</p>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="background: #f8f6f0; padding: 5px 10px; border-radius: 0; font-size: 0.9rem;">
                                ${getCategoryName(item.category_id)}
                            </span>
                            <span style="color: #d4af37; font-weight: 600;">查看详情 →</span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
        }
        
        if (data.knowledge.length > 0) {
            html += '<h3 style="margin: 30px 0 20px 0; color: #2c3e50;">相关知识</h3>';
            
            data.knowledge.forEach(knowledge => {
                html += `
                    <div class="card" style="margin-bottom: 20px;">
                        <h4 style="color: #d4af37; margin-bottom: 10px;">${knowledge.title}</h4>
                        <p style="color: #666; line-height: 1.6;">${knowledge.content.substring(0, 200)}...</p>
                        <div style="margin-top: 15px;">
                            <span style="background: #f8f6f0; padding: 5px 10px; border-radius: 0; font-size: 0.9rem;">
                                知识库
                            </span>
                        </div>
                    </div>
                `;
            });
        }
        
        searchContent.innerHTML = html;
    }
    
    function getCategoryName(categoryId) {
        const categories = {
            1: '民间文学',
            2: '传统音乐',
            3: '传统舞蹈',
            4: '传统戏剧',
            5: '曲艺',
            6: '传统体育、游艺与杂技',
            7: '传统美术',
            8: '传统技艺',
            9: '传统医药',
            10: '民俗'
        };
        return categories[categoryId] || '未知分类';
    }
    
    function addScrollAnimation() {
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        }, observerOptions);
        
        document.querySelectorAll('.category-card').forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(30px)';
            card.style.transition = `opacity 0.6s ease ${index * 0.1}s, transform 0.6s ease ${index * 0.1}s`;
            observer.observe(card);
        });
    }
</script>
{% endblock %}